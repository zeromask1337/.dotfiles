name: Test Bootstrap Installer

on:
  push:
    branches: [main, master]
    paths:
      - 'install.sh'
      - 'tests/**'
      - '.Brewfile'
      - '.github/workflows/test-bootstrap.yml'
  pull_request:
    paths:
      - 'install.sh'
      - 'tests/**'
      - '.Brewfile'
      - '.github/workflows/test-bootstrap.yml'
  workflow_dispatch:

jobs:
  test-ubuntu:
    name: Ubuntu Integration Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build test image
        run: ./tests/docker/test-runner.sh build
      
      - name: Setup dummy SSH key
        run: |
          mkdir -p ~/.ssh
          touch ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
      
      - name: Test preflight
        run: ./tests/docker/test-runner.sh step preflight
      
      - name: Test SSH (check existing key)
        run: ./tests/docker/test-runner.sh step ssh
        env:
          SKIP_SSH_GITHUB_CHECK: 1
      
      - name: Test Homebrew bootstrap (including clone)
        run: ./tests/docker/test-runner.sh prefix "preflight,ssh,clone,brew"
        timeout-minutes: 30
      
      - name: Test brew bundle (Linux subset)
        run: ./tests/docker/test-runner.sh prefix "preflight,ssh,clone,brew,bundle"
        timeout-minutes: 40
  
  test-macos:
    name: macOS Smoke Tests
    runs-on: macos-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Test preflight (macOS)
        run: ./install.sh --dry-run --only preflight
      
      - name: Test clone (dry-run)
        run: ./install.sh --dry-run --only clone
      
      - name: Test brew step (already installed)
        run: ./install.sh --dry-run --only brew
      
      - name: Verify Brewfile syntax
        run: |
          if command -v brew >/dev/null 2>&1; then
            brew bundle check --file=.Brewfile || echo "Some packages not installed (expected in CI)"
          fi
  
  lint:
    name: Shell Script Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Run shellcheck
        run: |
          sudo apt-get update && sudo apt-get install -y shellcheck
          shellcheck install.sh tests/docker/test-runner.sh
